services:
  # MongoDB Database
  mongodb:
    image: mongo:7
    container_name: laravel_mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-password}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-task-test}
    volumes:
      - mongodb_data:/data/db
    networks:
      - laravel_network
    healthcheck:
      test: mongosh --eval "db.runCommand('ping').ok" --quiet || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # PHP Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: laravel_app
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./:/var/www/html
      - ./docker/php/local.ini:/usr/local/etc/php/conf.d/local.ini
    networks:
      - laravel_network
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      - APP_ENV=${APP_ENV:-local}
      - APP_DEBUG=${APP_DEBUG:-true}
      - DB_CONNECTION=mongodb
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=${MONGODB_DATABASE:-task-test}
      - MONGODB_USERNAME=${MONGODB_USERNAME:-admin}
      - MONGODB_PASSWORD=${MONGODB_PASSWORD:-password}
      - MONGODB_AUTHENTICATION_DATABASE=admin
      - PHP_OPCACHE_ENABLE=0
    entrypoint: ["/var/www/html/docker/entrypoint.sh"]
    command: ["php-fpm"]

  # Nginx Web Server
  nginx:
    image: nginx:alpine
    container_name: laravel_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./docker/nginx/ssl:/etc/nginx/ssl
      - /var/www/certbot:/var/www/certbot:ro
      - certbot-etc:/etc/letsencrypt:ro
      - certbot-var:/var/lib/letsencrypt:ro
    networks:
      - laravel_network
    depends_on:
      - app

volumes:
  mongodb_data:
    driver: local
  certbot-etc:
    external: true
  certbot-var:
    external: true

networks:
  laravel_network:
    driver: bridge
